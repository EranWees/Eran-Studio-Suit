<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google OAuth Demo (Implicit Flow)</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white min-h-screen flex items-center justify-center">

    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-md w-full text-center space-y-6">
        <h1 class="text-2xl font-bold">Google OAuth Demo</h1>

        <!-- Login Section -->
        <div id="login-section">
            <p class="text-gray-400 mb-4">Sign in to see your profile.</p>
            <button id="btn-login"
                class="bg-white text-black px-6 py-3 rounded-full font-bold hover:bg-gray-200 transition flex items-center justify-center gap-2 w-full">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="Google">
                Sign in with Google
            </button>
        </div>

        <!-- User Section (Hidden by default) -->
        <div id="user-section" class="hidden space-y-4">
            <img id="user-avatar" src="" alt="Profile" class="w-20 h-20 rounded-full mx-auto border-4 border-blue-500">
            <div>
                <h2 id="user-name" class="text-xl font-bold"></h2>
                <p id="user-email" class="text-gray-400 text-sm"></p>
            </div>
            <div class="bg-gray-900 p-4 rounded-lg text-left text-xs font-mono overflow-x-auto">
                <p class="text-gray-500 mb-1">Access Token:</p>
                <p id="access-token" class="text-green-400 truncate"></p>
            </div>
            <button id="btn-logout" class="text-red-400 hover:text-red-300 text-sm font-medium">Sign Out</button>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const CLIENT_ID = '216951451858-682l3j2lmstp2gpar8uihtf2pnak7ecc.apps.googleusercontent.com'; // Your Client ID

        // IMPORTANT: This URL must be added to "Authorized redirect URIs" in Google Cloud Console
        // For GitHub Pages, it will be https://yourname.github.io/repo/auth_demo.html
        // For Localhost, it might be http://localhost:5173/auth_demo.html
        const REDIRECT_URI = window.location.href.split('#')[0];

        // Scopes: profile email (for identity) + any API scopes you need
        const SCOPE = 'https://www.googleapis.com/auth/userinfo.profile https://www.googleapis.com/auth/userinfo.email';

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const userSection = document.getElementById('user-section');
        const btnLogin = document.getElementById('btn-login');
        const btnLogout = document.getElementById('btn-logout');

        // --- Auth Logic ---

        // 1. Handle Login Click
        btnLogin.onclick = () => {
            // Construct the OAuth 2.0 Implicit Flow URL
            // We use 'response_type=token' to get the access token directly in the URL hash
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPE)}&include_granted_scopes=true&state=pass-through-value`;

            // Redirect the user to Google
            window.location.href = authUrl;
        };

        // 2. Handle Page Load (Check for Token)
        window.onload = () => {
            // Check if we have a token in localStorage
            const storedToken = localStorage.getItem('google_access_token');
            if (storedToken) {
                validateAndDisplayUser(storedToken);
                return;
            }

            // Check if we just came back from Google (Token in URL Hash)
            const hash = window.location.hash;
            if (hash && hash.includes('access_token')) {
                // Extract token
                const params = new URLSearchParams(hash.substring(1)); // remove #
                const accessToken = params.get('access_token');

                if (accessToken) {
                    // Save to localStorage
                    localStorage.setItem('google_access_token', accessToken);

                    // Clear the hash from the URL for cleanliness
                    window.history.replaceState(null, null, ' ');

                    validateAndDisplayUser(accessToken);
                }
            }
        };

        // 3. Validate Token & Fetch User Info
        async function validateAndDisplayUser(accessToken) {
            try {
                // Fetch user profile using the access token
                const response = await fetch('https://www.googleapis.com/oauth2/v1/userinfo?alt=json', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showUser(data, accessToken);
                } else {
                    // Token invalid or expired
                    handleLogout();
                }
            } catch (error) {
                console.error('Error fetching user:', error);
                handleLogout();
            }
        }

        // 4. Update UI
        function showUser(user, token) {
            loginSection.classList.add('hidden');
            userSection.classList.remove('hidden');

            document.getElementById('user-name').textContent = user.name;
            document.getElementById('user-email').textContent = user.email;
            document.getElementById('user-avatar').src = user.picture;
            document.getElementById('access-token').textContent = token;
        }

        // 5. Handle Logout
        function handleLogout() {
            localStorage.removeItem('google_access_token');
            loginSection.classList.remove('hidden');
            userSection.classList.add('hidden');
        }

        btnLogin.onclick = handleLogout; // Wait, this is wrong in the snippet logic above, fixing:
        document.getElementById('btn-logout').onclick = handleLogout;
        document.getElementById('btn-login').onclick = () => {
            const authUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${encodeURIComponent(SCOPE)}&include_granted_scopes=true&state=pass-through-value`;
            window.location.href = authUrl;
        };

    </script>
</body>

</html>